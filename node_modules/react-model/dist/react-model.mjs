import t from"immer";import{createContext as e,PureComponent as n,useEffect as o,useState as r,createElement as i}from"react";var c={Actions:{},AsyncState:{},Context:{__global:{}},Middlewares:{},Setter:{classSetter:void 0,functionSetter:{}},State:{},devTools:void 0,subscriptions:{},uid:0,withDevTools:!1},s=function(t,e){try{return Promise.resolve((0,t.next)(e).catch(function(t){return console.log(t)})).then(function(){})}catch(t){return Promise.reject(t)}},a=function(t,e){try{var n=t.modelName,o=t.next,r=t.Global;return Promise.resolve((0,t.action)(t.params,Object.assign({},{actions:(0,t.consumerActions)(r.Actions[n],{modelName:n}),state:r.State[n]},r.Context.__global||{},r.Context[n]||{}))).then(function(n){return t.newState=n||null,Promise.resolve(o(e)).then(function(){})})}catch(t){return Promise.reject(t)}},u=function(t,e){try{var n=t.modelName,o=t.newState,r=t.next,i=function(){if(o)return N(n,o),Promise.resolve(r(e)).then(function(){})}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},l=function(t,e){try{var n=t.next;return"function"===t.type&&t.setState&&t.setState(t.Global.State[t.modelName]),Promise.resolve(n(e)).then(function(){})}catch(t){return Promise.reject(t)}},f=function(t,e){try{var n=t.next,o=t.Global.subscriptions[t.modelName+"_"+t.actionName];return o&&o.forEach(function(t){t()}),Promise.resolve(n(e)).then(function(){})}catch(t){return Promise.reject(t)}},m=function(t,e){try{var n=t.Global;return console.group("%c "+t.modelName+" State Change %c "+(new Date).toLocaleTimeString(),"color: gray; font-weight: lighter;","color: black; font-weight: bold;"),console.log("%c Previous","color: #9E9E9E; font-weight: bold",n.State[t.modelName]),console.log("%c Action","color: #03A9F4; font-weight: bold",t.actionName,"payload: "+t.params),Promise.resolve(t.next(e)).then(function(){console.log("%c Next","color: #4CAF50; font-weight: bold",n.State[t.modelName]),console.groupEnd()})}catch(t){return Promise.reject(t)}},d=function(t,e){try{var n=t.Global;return Promise.resolve(t.next(e)).then(function(){n.withDevTools&&n.devTools.send(t.modelName+"_"+t.actionName,n.State)})}catch(t){return Promise.reject(t)}},S=function(t,e){try{var n=t.modelName,o=t.next,r=t.actionName,i=t.Global;return i.Setter.classSetter&&i.Setter.classSetter(i.State),i.Setter.functionSetter[n]&&Object.keys(i.Setter.functionSetter[n]).map(function(t){var e=i.Setter.functionSetter[n][t];e&&(e.depActions&&-1===e.depActions.indexOf(r)||e.setState(i.State[n]))}),Promise.resolve(o(e)).then(function(){})}catch(t){return Promise.reject(t)}},v=[a,u,l,S,f];v="production"===process.env.NODE_ENV?[s].concat(v):[m,d].concat(v);var h={communicator:S,consoleDebugger:m,devToolsListener:d,getNewState:a,getNewStateWithCache:function(t){return void 0===t&&(t=5e3),function(e,n){try{var o=e.Global,r=e.modelName,i=e.next,c=e.actionName;return Promise.resolve(Promise.race([(0,e.action)(e.params,{actions:(0,e.consumerActions)(o.Actions[r],{modelName:r}),state:o.State[r]}),w(t,O(r,c))])).then(function(t){return e.newState=t||null,Promise.resolve(i(n)).then(function(){})})}catch(t){return Promise.reject(t)}}},setNewState:u,stateUpdater:l,subscription:f,tryCatch:s},p=function(t,e){try{e.next=function(t){return t.length>0&&t[0](e,t.slice(1))};var n=function(){if(t.length>0)return Promise.resolve(t[0](e,t.slice(1))).then(function(){})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},_=e({}),b=_.Consumer;if(!console.group){var g=[],y="-".repeat(80);console.group=function(t){g.push(t),console.log("%c \nBEGIN GROUP: %c",y,t),console.groupEnd=function(){console.log("END GROUP: %c\n%c",g.pop(),y)}}}var P=function(t,e){var n={};return Object.entries(t).forEach(function(t){n[t[0]]=function(t,e){return function(n,o){try{return Promise.resolve(p(v,{Global:c,action:t,actionName:t.name,consumerActions:P,middlewareConfig:o,modelName:e.modelName,newState:null,params:n,type:"outer"})).then(function(){})}catch(t){return Promise.reject(t)}}}(t[1],e)}),n},N=function(e,n){if("function"==typeof n){var o=c.State[e];o=t(o,n),c.State=t(c.State,function(t){t[e]=o})}else c.State=t(c.State,function(t){t[e]=Object.assign({},t[e],n)});return c.State},w=function(t,e){return new Promise(function(n){return setTimeout(function(){console.log(t),n(e)},t)})},j=function(t){try{return Promise.resolve(Promise.all(Object.keys(c.State).map(function(e){try{var n=function(){if(!t||!t.modelName||e===t.modelName||-1!==t.modelName.indexOf(e)){function n(t){c.State[e]=Object.assign({},c.State[e],t)}var o=c.AsyncState[e];return o?Promise.resolve(o(t)).then(n):n({})}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}}))).then(function(){return c.State})}catch(t){return Promise.reject(t)}},O=function(t,e){var n=localStorage.getItem("__REACT_MODELX__"+t+"_"+e);return n?JSON.parse(n):null},A=function(t){return void 0!==t.state},E=function(t){return void 0!==t.useStore};function x(t,e,n){if(A(t)){c.uid+=1;var o="__"+c.uid;c.State[o]=t.state,t.middlewares&&(c.Middlewares[o]=t.middlewares),c.Actions[o]=t.actions,c.AsyncState[o]=t.asyncState,e&&(c.Context[o]=e);var r=G(o);return{__id:o,actions:r,getState:D(o),subscribe:function(t,e){return C(o,t,e)},unsubscribe:function(t){return T(o,t)},useStore:function(t){return M(o,t)}}}e&&(c.State=e||{}),n&&(c.Context.__global=n),Object.entries(t).forEach(function(t){var n=t[0],o=t[1];E(o)?(c.State[n]&&e||(c.State[n]=c.State[o.__id]),c.Actions[n]=c.Actions[o.__id],c.AsyncState[n]=c.AsyncState[o.__id],c.Middlewares[n]=c.Middlewares[o.__id],c.Context[n]=c.Context[o.__id]):(c.State[n]||(c.State[n]=o.state),o.middlewares&&(c.Middlewares[n]=o.middlewares),c.Actions[n]=o.actions,c.AsyncState[n]=o.asyncState)});var i=Object.keys(t).reduce(function(t,e){var n;return Object.assign({},t,((n={})[e]=G(e),n))},{});return c.withDevTools="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__,c.withDevTools&&(c.devTools=window.__REDUX_DEVTOOLS_EXTENSION__,c.devTools.connect()),{actions:i,getActions:G,getInitialState:j,getState:D,subscribe:C,unsubscribe:T,useStore:M}}var T=function(t,e){C(t,e,void 0)},C=function(t,e,n){Array.isArray(e)?e.forEach(function(e){c.subscriptions[t+"_"+e]||(c.subscriptions[t+"_"+e]=[]),n?c.subscriptions[t+"_"+e].push(n):c.subscriptions[t+"_"+e]=[]}):(c.subscriptions[t+"_"+e]||(c.subscriptions[t+"_"+e]=[]),n?c.subscriptions[t+"_"+e].push(n):c.subscriptions[t+"_"+e]=[])},D=function(t){return c.State[t]},G=function(t,e){void 0===e&&(e={type:"outer"});var n={};return Object.entries(c.Actions[t]).forEach(function(o){var r=o[0],i=o[1];return n[r]=function(n,o){try{var s=Object.assign({},{action:i,actionName:r,consumerActions:P,middlewareConfig:o,modelName:t,newState:null,params:n},e,{Global:c}),a=c.Middlewares[t]?Promise.resolve(p(c.Middlewares[t],s)).then(function(){}):Promise.resolve(p(v,s)).then(function(){});return Promise.resolve(a&&a.then?a.then(function(){}):void 0)}catch(t){return Promise.reject(t)}}}),n},M=function(t,e){var n=r(c.State[t])[1];o(function(){c.uid+=1;var o=""+c.uid;return c.Setter.functionSetter[t]||(c.Setter.functionSetter[t]={}),c.Setter.functionSetter[t][o]={setState:n,depActions:e},function(){delete c.Setter.functionSetter[t][o]}},[]);var i=G(t,{setState:n,type:"function"});return[D(t),i]},I=function(t){function e(){t.apply(this,arguments),this.state=c.State}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.render=function(){var t=this.props.children;return c.Setter.classSetter=this.setState.bind(this),i(_.Provider,{value:Object.assign({},this.state)},t)},e}(n),L=function(t,e,o){return function(r){return function(n){function s(){n.apply(this,arguments)}return n&&(s.__proto__=n),(s.prototype=Object.create(n&&n.prototype)).constructor=s,s.prototype.render=function(){var n=this,s=this.props,a=s.state;void 0===a&&(a={});var u=s.actions;return void 0===u&&(u={}),i(b,null,function(s){var l=s[""+t],f=c.Actions[t];return i(r,Object.assign({},n.props,{state:Object.assign({},a,e?e(l):l),actions:Object.assign({},u,o?o(P(f,{modelName:t})):P(f,{modelName:t}))}))})},s}(n)}};export{v as actionMiddlewares,x as Model,h as middlewares,I as Provider,b as Consumer,L as connect,D as getState,j as getInitialState};
