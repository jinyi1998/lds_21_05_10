!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("immer"),require("react")):"function"==typeof define&&define.amd?define(["exports","immer","react"],t):t(e.reactModel={},e.immer,e.react)}(this,function(e,t,n){t=t&&t.hasOwnProperty("default")?t.default:t;var o={Actions:{},AsyncState:{},Context:{__global:{}},Middlewares:{},Setter:{classSetter:void 0,functionSetter:{}},State:{},devTools:void 0,subscriptions:{},uid:0,withDevTools:!1},r=function(e,t){try{return Promise.resolve((0,e.next)(t).catch(function(e){return console.log(e)})).then(function(){})}catch(e){return Promise.reject(e)}},i=function(e,t){try{var n=e.modelName,o=e.next,r=e.Global;return Promise.resolve((0,e.action)(e.params,Object.assign({},{actions:(0,e.consumerActions)(r.Actions[n],{modelName:n}),state:r.State[n]},r.Context.__global||{},r.Context[n]||{}))).then(function(n){return e.newState=n||null,Promise.resolve(o(t)).then(function(){})})}catch(e){return Promise.reject(e)}},c=function(e,t){try{var n=e.modelName,o=e.newState,r=e.next,i=function(){if(o)return b(n,o),Promise.resolve(r(t)).then(function(){})}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},a=function(e,t){try{var n=e.next;return"function"===e.type&&e.setState&&e.setState(e.Global.State[e.modelName]),Promise.resolve(n(t)).then(function(){})}catch(e){return Promise.reject(e)}},s=function(e,t){try{var n=e.next,o=e.Global.subscriptions[e.modelName+"_"+e.actionName];return o&&o.forEach(function(e){e()}),Promise.resolve(n(t)).then(function(){})}catch(e){return Promise.reject(e)}},u=function(e,t){try{var n=e.Global;return console.group("%c "+e.modelName+" State Change %c "+(new Date).toLocaleTimeString(),"color: gray; font-weight: lighter;","color: black; font-weight: bold;"),console.log("%c Previous","color: #9E9E9E; font-weight: bold",n.State[e.modelName]),console.log("%c Action","color: #03A9F4; font-weight: bold",e.actionName,"payload: "+e.params),Promise.resolve(e.next(t)).then(function(){console.log("%c Next","color: #4CAF50; font-weight: bold",n.State[e.modelName]),console.groupEnd()})}catch(e){return Promise.reject(e)}},l=function(e,t){try{var n=e.Global;return Promise.resolve(e.next(t)).then(function(){n.withDevTools&&n.devTools.send(e.modelName+"_"+e.actionName,n.State)})}catch(e){return Promise.reject(e)}},d=function(e,t){try{var n=e.modelName,o=e.next,r=e.actionName,i=e.Global;return i.Setter.classSetter&&i.Setter.classSetter(i.State),i.Setter.functionSetter[n]&&Object.keys(i.Setter.functionSetter[n]).map(function(e){var t=i.Setter.functionSetter[n][e];t&&(t.depActions&&-1===t.depActions.indexOf(r)||t.setState(i.State[n]))}),Promise.resolve(o(t)).then(function(){})}catch(e){return Promise.reject(e)}};e.actionMiddlewares=[i,c,a,d,s],e.actionMiddlewares="production"===process.env.NODE_ENV?[r].concat(e.actionMiddlewares):[u,l].concat(e.actionMiddlewares);var f={communicator:d,consoleDebugger:u,devToolsListener:l,getNewState:i,getNewStateWithCache:function(e){return void 0===e&&(e=5e3),function(t,n){try{var o=t.Global,r=t.modelName,i=t.next,c=t.actionName;return Promise.resolve(Promise.race([(0,t.action)(t.params,{actions:(0,t.consumerActions)(o.Actions[r],{modelName:r}),state:o.State[r]}),g(e,w(r,c))])).then(function(e){return t.newState=e||null,Promise.resolve(i(n)).then(function(){})})}catch(e){return Promise.reject(e)}}},setNewState:c,stateUpdater:a,subscription:s,tryCatch:r},m=function(e,t){try{t.next=function(e){return e.length>0&&e[0](t,e.slice(1))};var n=function(){if(e.length>0)return Promise.resolve(e[0](t,e.slice(1))).then(function(){})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},S=n.createContext({}),v=S.Consumer;if(!console.group){var h=[],p="-".repeat(80);console.group=function(e){h.push(e),console.log("%c \nBEGIN GROUP: %c",p,e),console.groupEnd=function(){console.log("END GROUP: %c\n%c",h.pop(),p)}}}var _=function(t,n){var r={};return Object.entries(t).forEach(function(t){r[t[0]]=function(t,n){return function(r,i){try{return Promise.resolve(m(e.actionMiddlewares,{Global:o,action:t,actionName:t.name,consumerActions:_,middlewareConfig:i,modelName:n.modelName,newState:null,params:r,type:"outer"})).then(function(){})}catch(e){return Promise.reject(e)}}}(t[1],n)}),r},b=function(e,n){if("function"==typeof n){var r=o.State[e];r=t(r,n),o.State=t(o.State,function(t){t[e]=r})}else o.State=t(o.State,function(t){t[e]=Object.assign({},t[e],n)});return o.State},g=function(e,t){return new Promise(function(n){return setTimeout(function(){console.log(e),n(t)},e)})},y=function(e){try{return Promise.resolve(Promise.all(Object.keys(o.State).map(function(t){try{var n=function(){if(!e||!e.modelName||t===e.modelName||-1!==e.modelName.indexOf(t)){function n(e){o.State[t]=Object.assign({},o.State[t],e)}var r=o.AsyncState[t];return r?Promise.resolve(r(e)).then(n):n({})}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}))).then(function(){return o.State})}catch(e){return Promise.reject(e)}},w=function(e,t){var n=localStorage.getItem("__REACT_MODELX__"+e+"_"+t);return n?JSON.parse(n):null},P=function(e,t){N(e,t,void 0)},N=function(e,t,n){Array.isArray(t)?t.forEach(function(t){o.subscriptions[e+"_"+t]||(o.subscriptions[e+"_"+t]=[]),n?o.subscriptions[e+"_"+t].push(n):o.subscriptions[e+"_"+t]=[]}):(o.subscriptions[e+"_"+t]||(o.subscriptions[e+"_"+t]=[]),n?o.subscriptions[e+"_"+t].push(n):o.subscriptions[e+"_"+t]=[])},j=function(e){return o.State[e]},O=function(t,n){void 0===n&&(n={type:"outer"});var r={};return Object.entries(o.Actions[t]).forEach(function(i){var c=i[0],a=i[1];return r[c]=function(r,i){try{var s=Object.assign({},{action:a,actionName:c,consumerActions:_,middlewareConfig:i,modelName:t,newState:null,params:r},n,{Global:o}),u=o.Middlewares[t]?Promise.resolve(m(o.Middlewares[t],s)).then(function(){}):Promise.resolve(m(e.actionMiddlewares,s)).then(function(){});return Promise.resolve(u&&u.then?u.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}}),r},A=function(e,t){var r=n.useState(o.State[e])[1];n.useEffect(function(){o.uid+=1;var n=""+o.uid;return o.Setter.functionSetter[e]||(o.Setter.functionSetter[e]={}),o.Setter.functionSetter[e][n]={setState:r,depActions:t},function(){delete o.Setter.functionSetter[e][n]}},[]);var i=O(e,{setState:r,type:"function"});return[j(e),i]},E=function(e){function t(){e.apply(this,arguments),this.state=o.State}return e&&(t.__proto__=e),(t.prototype=Object.create(e&&e.prototype)).constructor=t,t.prototype.render=function(){var e=this.props.children;return o.Setter.classSetter=this.setState.bind(this),n.createElement(S.Provider,{value:Object.assign({},this.state)},e)},t}(n.PureComponent);e.Model=function(e,t,n){if(void 0!==e.state){o.uid+=1;var r="__"+o.uid;o.State[r]=e.state,e.middlewares&&(o.Middlewares[r]=e.middlewares),o.Actions[r]=e.actions,o.AsyncState[r]=e.asyncState,t&&(o.Context[r]=t);var i=O(r);return{__id:r,actions:i,getState:j(r),subscribe:function(e,t){return N(r,e,t)},unsubscribe:function(e){return P(r,e)},useStore:function(e){return A(r,e)}}}t&&(o.State=t||{}),n&&(o.Context.__global=n),Object.entries(e).forEach(function(e){var n=e[0],r=e[1];void 0!==r.useStore?(o.State[n]&&t||(o.State[n]=o.State[r.__id]),o.Actions[n]=o.Actions[r.__id],o.AsyncState[n]=o.AsyncState[r.__id],o.Middlewares[n]=o.Middlewares[r.__id],o.Context[n]=o.Context[r.__id]):(o.State[n]||(o.State[n]=r.state),r.middlewares&&(o.Middlewares[n]=r.middlewares),o.Actions[n]=r.actions,o.AsyncState[n]=r.asyncState)});var c=Object.keys(e).reduce(function(e,t){var n;return Object.assign({},e,((n={})[t]=O(t),n))},{});return o.withDevTools="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__,o.withDevTools&&(o.devTools=window.__REDUX_DEVTOOLS_EXTENSION__,o.devTools.connect()),{actions:c,getActions:O,getInitialState:y,getState:j,subscribe:N,unsubscribe:P,useStore:A}},e.middlewares=f,e.Provider=E,e.Consumer=v,e.connect=function(e,t,r){return function(i){return function(c){function a(){c.apply(this,arguments)}return c&&(a.__proto__=c),(a.prototype=Object.create(c&&c.prototype)).constructor=a,a.prototype.render=function(){var c=this,a=this.props,s=a.state;void 0===s&&(s={});var u=a.actions;return void 0===u&&(u={}),n.createElement(v,null,function(a){var l=a[""+e],d=o.Actions[e];return n.createElement(i,Object.assign({},c.props,{state:Object.assign({},s,t?t(l):l),actions:Object.assign({},u,r?r(_(d,{modelName:e})):_(d,{modelName:e}))}))})},a}(n.PureComponent)}},e.getState=j,e.getInitialState=y});
